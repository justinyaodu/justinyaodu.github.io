<!DOCTYPE html><html lang="en-us"><head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="/assets/styles/main.css">
    <link rel="stylesheet" href="/assets/katex/katex.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="">
    <link href="https://fonts.googleapis.com/css2?family=Source+Code+Pro:wght@300;500;600;700&amp;family=Montserrat:ital,wght@0,300;0,400;0,700;1,300;1,400;1,700&amp;display=block" rel="stylesheet">
  <title>Making an LRU cache out of two hashmaps</title></head>
  <body>
    <main><header><h1>Making an LRU cache out of two hashmaps</h1><p><time datetime="2023-12-02">2023-12-02</time></p></header>

<p>Look ma, no linked lists!</p>
<h2 id="background"><a href="#background">Background</a></h2>
<p>An <a href="https://redis.com/glossary/lru-cache/" class="link">LRU cache</a> with a capacity of <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi></mrow><annotation encoding="application/x-tex">n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">n</span></span></span></span> elements should:</p>
<ol>
<li>Set a key-value pair in <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="script">O</mi><mo stretchy="false">(</mo><mn>1</mn><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\mathcal{O}(1)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathcal" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord">1</span><span class="mclose">)</span></span></span></span> time</li>
<li>Get the value associated with one of the <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi></mrow><annotation encoding="application/x-tex">n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">n</span></span></span></span> most recently used keys in <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="script">O</mi><mo stretchy="false">(</mo><mn>1</mn><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\mathcal{O}(1)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathcal" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord">1</span><span class="mclose">)</span></span></span></span> time</li>
<li>Use <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="script">O</mi><mo stretchy="false">(</mo><mi>n</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\mathcal{O}(n)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathcal" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord mathnormal">n</span><span class="mclose">)</span></span></span></span> memory</li>
</ol>
<p>A hashmap has <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="script">O</mi><mo stretchy="false">(</mo><mn>1</mn><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\mathcal{O}(1)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathcal" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord">1</span><span class="mclose">)</span></span></span></span> set and get, but if you never remove anything, it uses more than <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="script">O</mi><mo stretchy="false">(</mo><mi>n</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\mathcal{O}(n)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathcal" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord mathnormal">n</span><span class="mclose">)</span></span></span></span> space. Typical LRU cache implementations pair a hashmap with a doubly linked list, which orders keys by how recently they were used. This enables efficient identification and removal of the least recently used key to maintain <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="script">O</mi><mo stretchy="false">(</mo><mi>n</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\mathcal{O}(n)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathcal" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord mathnormal">n</span><span class="mclose">)</span></span></span></span> memory usage.</p>
<p>I promised no linked lists though, so let’s try something else.</p>
<h2 id="the-algorithm"><a href="#the-algorithm">The algorithm</a></h2>
<p>Instead of using one hashmap, we use two hashmaps of different sizes:</p>
<ol>
<li>The <em>leader</em> caches the <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>n</mi><mn>1</mn></msub></mrow><annotation encoding="application/x-tex">n_1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">n</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> most recent keys, where <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>n</mi><mn>1</mn></msub></mrow><annotation encoding="application/x-tex">n_1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">n</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> changes over time, but is always <strong>at least</strong> <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi></mrow><annotation encoding="application/x-tex">n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">n</span></span></span></span>.</li>
<li>The <em>follower</em> caches the <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>n</mi><mn>2</mn></msub></mrow><annotation encoding="application/x-tex">n_2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">n</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> most recent keys, where <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>n</mi><mn>2</mn></msub></mrow><annotation encoding="application/x-tex">n_2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">n</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> changes over time, but is always <strong>less than</strong> <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi></mrow><annotation encoding="application/x-tex">n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">n</span></span></span></span>.</li>
</ol>
<aside class="info">

<p>If fewer than <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi></mrow><annotation encoding="application/x-tex">n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">n</span></span></span></span> keys have been used so far, let’s say <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>k</mi></mrow><annotation encoding="application/x-tex">k</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span></span></span></span>, then <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>n</mi><mn>1</mn></msub><mo>=</mo><mi>k</mi></mrow><annotation encoding="application/x-tex">n_1 = k</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">n</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span></span></span></span> instead.</p>
</aside>
<p>Since <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>n</mi><mn>1</mn></msub><mo>≥</mo><mi>n</mi></mrow><annotation encoding="application/x-tex">n_1 \ge n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.786em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">n</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">≥</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">n</span></span></span></span>, the leader contains all the keys that an LRU cache with a capacity of <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi></mrow><annotation encoding="application/x-tex">n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">n</span></span></span></span> would have, so we make the leader handle all the get and set operations. Whenever we access the leader, we also update the follower with the corresponding key-value pair.</p>
<p>The leader and the follower both grow over time, but preventing unbounded growth is actually quite straightforward. Once the follower reaches a size of <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi></mrow><annotation encoding="application/x-tex">n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">n</span></span></span></span>, we replace the leader with the follower, and create a new, empty follower. This preserves our invariants, <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>n</mi><mn>1</mn></msub><mo>≥</mo><mi>n</mi></mrow><annotation encoding="application/x-tex">n_1 \ge n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.786em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">n</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">≥</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">n</span></span></span></span> and <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>n</mi><mn>2</mn></msub><mo>&lt;</mo><mi>n</mi></mrow><annotation encoding="application/x-tex">n_2 &lt; n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6891em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">n</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">&lt;</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">n</span></span></span></span>, and evicts the keys that are not in the <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi></mrow><annotation encoding="application/x-tex">n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">n</span></span></span></span> most recently used. Deallocating the old leader may take <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="script">O</mi><mo stretchy="false">(</mo><mi>n</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\mathcal{O}(n)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathcal" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord mathnormal">n</span><span class="mclose">)</span></span></span></span> time, but we only do this once every <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi></mrow><annotation encoding="application/x-tex">n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">n</span></span></span></span> operations in the worst case, so each operation is still amortized <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="script">O</mi><mo stretchy="false">(</mo><mn>1</mn><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\mathcal{O}(1)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathcal" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord">1</span><span class="mclose">)</span></span></span></span>.</p>
<p>The size of the leader is always less than <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>2</mn><mi>n</mi></mrow><annotation encoding="application/x-tex">2n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">2</span><span class="mord mathnormal">n</span></span></span></span>, because any operation that increases the leader’s size will also increase the follower’s size, and we replace the leader after the follower’s size increases <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi></mrow><annotation encoding="application/x-tex">n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">n</span></span></span></span> times. Thus, the space complexity is the desired <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="script">O</mi><mo stretchy="false">(</mo><mi>n</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\mathcal{O}(n)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathcal" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord mathnormal">n</span><span class="mclose">)</span></span></span></span>.</p>
<h2 id="implementation"><a href="#implementation">Implementation</a></h2>
<p>In TypeScript:</p>
<pre tabindex="0"><code class="language-ts"><span class="line"><span style="color: #93A1A1; font-style: italic">// I release this code into the public domain - feel free to use it!</span></span>
<span class="line"></span>
<span class="line"><span style="color: #93A1A1; font-style: italic">// This work is marked with CC0 1.0. To view a copy of this</span></span>
<span class="line"><span style="color: #93A1A1; font-style: italic">// license, visit https://creativecommons.org/publicdomain/zero/1.0</span></span>
<span class="line"></span>
<span class="line"><span style="color: #586E75; font-weight: bold">class</span><span style="color: #657B83"> </span><span style="color: #CB4B16">LRUCache</span><span style="color: #657B83">&lt;</span><span style="color: #CB4B16">K</span><span style="color: #657B83">, </span><span style="color: #CB4B16">V</span><span style="color: #657B83">&gt; {</span></span>
<span class="line"><span style="color: #657B83">  </span><span style="color: #586E75; font-weight: bold">private</span><span style="color: #657B83"> leader </span><span style="color: #859900">=</span><span style="color: #657B83"> </span><span style="color: #859900">new</span><span style="color: #657B83"> </span><span style="color: #268BD2">Map</span><span style="color: #657B83">&lt;</span><span style="color: #CB4B16">K</span><span style="color: #657B83">, </span><span style="color: #CB4B16">V</span><span style="color: #657B83">&gt;();</span></span>
<span class="line"><span style="color: #657B83">  </span><span style="color: #586E75; font-weight: bold">private</span><span style="color: #657B83"> follower </span><span style="color: #859900">=</span><span style="color: #657B83"> </span><span style="color: #859900">new</span><span style="color: #657B83"> </span><span style="color: #268BD2">Map</span><span style="color: #657B83">&lt;</span><span style="color: #CB4B16">K</span><span style="color: #657B83">, </span><span style="color: #CB4B16">V</span><span style="color: #657B83">&gt;();</span></span>
<span class="line"></span>
<span class="line"><span style="color: #657B83">  </span><span style="color: #586E75; font-weight: bold">constructor</span><span style="color: #657B83">(</span><span style="color: #586E75; font-weight: bold">private</span><span style="color: #657B83"> </span><span style="color: #586E75; font-weight: bold">readonly</span><span style="color: #657B83"> capacity</span><span style="color: #859900">:</span><span style="color: #657B83"> </span><span style="color: #859900">number</span><span style="color: #657B83">) {}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #657B83">  </span><span style="color: #268BD2">set</span><span style="color: #657B83">(key</span><span style="color: #859900">:</span><span style="color: #657B83"> </span><span style="color: #CB4B16">K</span><span style="color: #657B83">, value</span><span style="color: #859900">:</span><span style="color: #657B83"> </span><span style="color: #CB4B16">V</span><span style="color: #657B83">)</span><span style="color: #859900">:</span><span style="color: #657B83"> </span><span style="color: #859900">void</span><span style="color: #657B83"> {</span></span>
<span class="line"><span style="color: #657B83">    </span><span style="color: #268BD2">this</span><span style="color: #657B83">.</span><span style="color: #268BD2">leader</span><span style="color: #657B83">.</span><span style="color: #268BD2">set</span><span style="color: #657B83">(</span><span style="color: #268BD2">key</span><span style="color: #657B83">, </span><span style="color: #268BD2">value</span><span style="color: #657B83">);</span></span>
<span class="line"><span style="color: #657B83">    </span><span style="color: #268BD2">this</span><span style="color: #657B83">.</span><span style="color: #268BD2">follow</span><span style="color: #657B83">(</span><span style="color: #268BD2">key</span><span style="color: #657B83">, </span><span style="color: #268BD2">value</span><span style="color: #657B83">);</span></span>
<span class="line"><span style="color: #657B83">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color: #657B83">  </span><span style="color: #268BD2">get</span><span style="color: #657B83">(key</span><span style="color: #859900">:</span><span style="color: #657B83"> </span><span style="color: #CB4B16">K</span><span style="color: #657B83">)</span><span style="color: #859900">:</span><span style="color: #657B83"> </span><span style="color: #CB4B16">V</span><span style="color: #657B83"> </span><span style="color: #859900">|</span><span style="color: #657B83"> </span><span style="color: #859900">undefined</span><span style="color: #657B83"> {</span></span>
<span class="line"><span style="color: #657B83">    </span><span style="color: #859900">if</span><span style="color: #657B83"> (</span><span style="color: #859900">!</span><span style="color: #268BD2">this</span><span style="color: #657B83">.</span><span style="color: #268BD2">leader</span><span style="color: #657B83">.</span><span style="color: #268BD2">has</span><span style="color: #657B83">(</span><span style="color: #268BD2">key</span><span style="color: #657B83">)) {</span></span>
<span class="line"><span style="color: #657B83">      </span><span style="color: #859900">return</span><span style="color: #657B83"> </span><span style="color: #B58900">undefined</span><span style="color: #657B83">;</span></span>
<span class="line"><span style="color: #657B83">    }</span></span>
<span class="line"><span style="color: #657B83">    </span><span style="color: #586E75; font-weight: bold">const</span><span style="color: #657B83"> </span><span style="color: #268BD2">value</span><span style="color: #657B83"> </span><span style="color: #859900">=</span><span style="color: #657B83"> </span><span style="color: #268BD2">this</span><span style="color: #657B83">.</span><span style="color: #268BD2">leader</span><span style="color: #657B83">.</span><span style="color: #268BD2">get</span><span style="color: #657B83">(</span><span style="color: #268BD2">key</span><span style="color: #657B83">)</span><span style="color: #859900">!</span><span style="color: #657B83">;</span></span>
<span class="line"><span style="color: #657B83">    </span><span style="color: #268BD2">this</span><span style="color: #657B83">.</span><span style="color: #268BD2">follow</span><span style="color: #657B83">(</span><span style="color: #268BD2">key</span><span style="color: #657B83">, </span><span style="color: #268BD2">value</span><span style="color: #657B83">);</span></span>
<span class="line"><span style="color: #657B83">    </span><span style="color: #859900">return</span><span style="color: #657B83"> </span><span style="color: #268BD2">value</span><span style="color: #657B83">;</span></span>
<span class="line"><span style="color: #657B83">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color: #657B83">  </span><span style="color: #586E75; font-weight: bold">private</span><span style="color: #657B83"> </span><span style="color: #268BD2">follow</span><span style="color: #657B83">(key</span><span style="color: #859900">:</span><span style="color: #657B83"> </span><span style="color: #CB4B16">K</span><span style="color: #657B83">, value</span><span style="color: #859900">:</span><span style="color: #657B83"> </span><span style="color: #CB4B16">V</span><span style="color: #657B83">)</span><span style="color: #859900">:</span><span style="color: #657B83"> </span><span style="color: #859900">void</span><span style="color: #657B83"> {</span></span>
<span class="line"><span style="color: #657B83">    </span><span style="color: #268BD2">this</span><span style="color: #657B83">.</span><span style="color: #268BD2">follower</span><span style="color: #657B83">.</span><span style="color: #268BD2">set</span><span style="color: #657B83">(</span><span style="color: #268BD2">key</span><span style="color: #657B83">, </span><span style="color: #268BD2">value</span><span style="color: #657B83">);</span></span>
<span class="line"><span style="color: #657B83">    </span><span style="color: #859900">if</span><span style="color: #657B83"> (</span><span style="color: #268BD2">this</span><span style="color: #657B83">.</span><span style="color: #268BD2">follower</span><span style="color: #657B83">.</span><span style="color: #268BD2">size</span><span style="color: #657B83"> </span><span style="color: #859900">===</span><span style="color: #657B83"> </span><span style="color: #268BD2">this</span><span style="color: #657B83">.</span><span style="color: #268BD2">capacity</span><span style="color: #657B83">) {</span></span>
<span class="line"><span style="color: #657B83">      </span><span style="color: #268BD2">this</span><span style="color: #657B83">.</span><span style="color: #268BD2">leader</span><span style="color: #657B83"> </span><span style="color: #859900">=</span><span style="color: #657B83"> </span><span style="color: #268BD2">this</span><span style="color: #657B83">.</span><span style="color: #268BD2">follower</span><span style="color: #657B83">;</span></span>
<span class="line"><span style="color: #657B83">      </span><span style="color: #268BD2">this</span><span style="color: #657B83">.</span><span style="color: #268BD2">follower</span><span style="color: #657B83"> </span><span style="color: #859900">=</span><span style="color: #657B83"> </span><span style="color: #859900">new</span><span style="color: #657B83"> </span><span style="color: #268BD2">Map</span><span style="color: #657B83">();</span></span>
<span class="line"><span style="color: #657B83">    }</span></span>
<span class="line"><span style="color: #657B83">  }</span></span>
<span class="line"><span style="color: #657B83">}</span></span>
<span class="line"></span></code></pre>
<aside class="info">

<p>If you want to avoid deallocating the leader and allocating a new follower, you can swap the leader and follower, then clear the follower. I haven’t benchmarked it though, and I thought the approach used above would be easier to understand.</p>
</aside>
<h2 id="should-i-use-this"><a href="#should-i-use-this">Should I use this?</a></h2>
<p>This approach is primarily useful if your hashmaps don’t preserve the insertion order of keys. If they do, there’s an even easier implementation: remove and reinsert existing keys whenever you access them, and remove the first key (which is also the least recently used) when the capacity is exceeded.</p>
<p>Hashmaps that preserve insertion order include JavaScript’s <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Map" class="link"><code>Map</code></a>, Python’s <a href="https://docs.python.org/3/library/stdtypes.html#dict" class="link"><code>dict</code></a> (since <a href="https://docs.python.org/3/whatsnew/3.7.html#summary-release-highlights" class="link">3.7</a>) and <a href="https://docs.python.org/3/library/collections.html#collections.OrderedDict" class="link"><code>OrderedDict</code></a>, and Java’s <a href="https://docs.oracle.com/javase/8/docs/api/java/util/LinkedHashMap.html" class="link"><code>LinkedHashMap</code></a>. Python also has <a href="https://docs.python.org/3/library/functools.html#functools.lru_cache" class="link"><code>functools.lru_cache</code></a> in the standard library, which lets you wrap an LRU cache around any pure function.</p>
<p>But if all else fails, at least you won’t need a linked list!</p>
</main>
  

</body></html>